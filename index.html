<!DOCTYPE html>
<html lang="en">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<head>
    <title>Composite plot template</title>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2.2.1/src/js.cookie.min.js"></script>
    <style>
        input[type=button] {
            height: 30px
        }

        input[type=color] {
            width: 40px;
            height: 40px
        }

        input[type=range] {
            width: 120px
        }

        .slider-text {
            width: 40px;
            margin-left: 10px
        }

        label {
            padding-right: 10px
        }

        .setting-text {
            width: 40px
        }

        div[contenteditable=true] {
            border: 1px solid #BBBBBB;
            box-shadow: 0px 0px 1px #BBBBBB;
            cursor: text
        }

        th {
            font-weight: bold
        }

        #metadata-table, #metadata-table th, #metadata-table td {
            font-size:12px;
            border: 1px solid black
        }

        #add-field {
            width: 50px;
            cursor: pointer;
            position: relative
        }

        .form-popup {
            position: absolute;
            top: 0;
            right: 15px;
            width: 350px;
            border: 3px solid #F1F1F1;
            background-color: #FFFFFF;
            z-index: 1;
        }

        .dropdown {
            position: absolute;
            display: none;
            left: -15px;
            width: 80px;
            background-color: #FFFFFF;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1
        }

        #add-field:hover .dropdown {
            display: block
        }

        .dropdown-element:hover {
            background-color: #DDDDDD
        }

        .dropdown-element.selected {
            background-color: #44FF44
        }

        .dropdown-element.selected:hover {
            background-color: #44DD44
        }

        #add-custom-field {
            background-color: #FFF8DC
        }

        #add-custom-field:hover {
            background-color: #EADDCA
        }

        td.mismatch {
            background-color: #FFDDDD
        }

        td.remove-row {
            width: 50px;
            cursor: pointer
        }

        #add-row {
            cursor:pointer
        }

        .remove-field-icon {
            position: absolute;
            height: 12px;
            width: 12px;
            top: 5px;
            right: 5px;
            cursor: pointer
        }

        .upload-icon {
            height: 20px;
            width: 20px
        }

        .hide-icon {
            height: 40px;
            width: 40px;
            cursor: pointer
        }

        #settings-table .added-row {
            cursor: grab
        }

        #settings-table .added-row label {
            cursor: grab
        }

        .mouse-highlight {
            border: 3px solid #8888FF
        }

        .drag-highlight {
            background-color: #DDDDDD
        }
    </style>
    <script>
        let reset = function() {
            $("#metadata-table").metadata_table("reset");
            $("#main-plot").main_plot("reset");
            $("#settings-table").settings_table("reset")
        };

        // Set up CSRF token for AJAX requests
        let csrftoken = Cookies.get('csrftoken');
        let csrfSafeMethod = function(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method))
        };
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                }
            }
        })
    </script>
</head>
<body>
    <main>
        <div class="container-fluid">
            <div class="row" style="padding-top:5px;">
                <div class="col-4">
                    <div class="row">
                        <div class="col">
                            <input type="button" id="json-button" value="Import JSON">
                            <input type="file" id="json-loader" style="display:none;">
                            <script>
                                $(function() {
                                    d3.select("#json-button").on("click", function() {
                                        let file_input = d3.select("#json-loader");
                                        file_input.node().value = null;
                                        file_input.node().click()
                                    });

                                    d3.select("#json-loader").on("input", function(ev) {
                                        reset();
                                        let file = event.target.files[0],
                                            reader = new FileReader();
                                        reader.onload = function() {
                                            let data;
                                            try {
                                                data = JSON.parse(reader.result)
                                            } catch (e) {
                                                alert("Invalid JSON file");
                                                return
                                            }

                                            let validate_json = function() {
                                                if (!data.metadata || !data.settings || !data.plot) {
                                                    return false
                                                };

                                                if (!data.metadata.basecols || !data.metadata.customcols || !data.metadata.rows) {
                                                    return false
                                                };

                                                if (data.metadata.rows.some(row => row.length !== data.metadata.basecols.length + data.metadata.customcols.length + 1)) {
                                                    return false
                                                };

                                                if (!data.plot.title || !data.plot.xlabel || !data.plot || isNaN(data.plot.xmin) ||
                                                    isNaN(data.plot.xmax) || isNaN(data.plot.ymax) || isNaN(data.plot.opacity) ||
                                                    !data.plot.smoothing || isNaN(data.plot.bp_shift) || isNaN(data.plot.combined)) {
                                                    return false
                                                };

                                                if (data.settings.some(function(setting) {
                                                    if (isNaN(setting.xmin) || isNaN(setting.xmax) || !setting.color || isNaN(setting.scale) ||
                                                        isNaN(setting.files_loaded)) {
                                                        return true
                                                    };

                                                    if (setting.files_loaded === 0 && setting.xmax === null && setting.xmin === null) {
                                                        return false
                                                    };

                                                    let range = setting.xmax - setting.xmin + 1;
                                                    if (setting.sense.length !== range || setting.anti.length !== range) {
                                                        return true
                                                    }
                                                })) {
                                                    return false
                                                };

                                                return true
                                            };

                                            if (!validate_json()) {
                                                alert("Invalid JSON file");
                                                return
                                            };

                                            $("#main-plot").main_plot("import", data.plot);
                                            $("#settings-table").settings_table("import", data.settings);
                                            $("#metadata-table").metadata_table("import", data.metadata);
                                            $("#main-plot").main_plot("update_legend")
                                        };
                                        reader.readAsText(file)
                                    })
                                })
                            </script>
                            <input type="button" id="json-download" value="Export JSON">
                            <script>
                                $(function() {
                                    d3.select("#json-download").on("click", function() {
                                        let data = {
                                            metadata: $("#metadata-table").metadata_table("export"),
                                            settings: $("#settings-table").settings_table("export"),
                                            plot: $("#main-plot").main_plot("export")
                                        },
                                            a = document.createElement("a"),
                                            e = new MouseEvent("click");
                                        a.download = "composite_plot_config.json";
                                        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                                        a.dispatchEvent(e)
                                    })
                                })
                            </script>
                        </div>
                    </div>
                </div>
                <div class="col-5">
                    <div class="row">
                        <div id="axes-input" class="col-8"></div>
                        <script>
                            $(function() {
                                // Axes input widget
                                $.widget("composite_plot.axes_input", {
                                    // Default axis limits
                                    xmin: -500,
                                    xmax: 500,
                                    ymax: 1,

                                    _elements: {
                                        xmin_text: null,
                                        xmax_text: null,
                                        ymax_text: null
                                    },

                                    _create: function() {
                                        let container = d3.select(this.element.context),
                                            xaxis = container.append("div")
                                                .attr("class", "row")
                                                .append("div")
                                                    .attr("class", "col"),
                                            yaxis = container.append("div")
                                                .attr("class", "row")
                                                .append("div")
                                                    .attr("class", "col");

                                        xaxis.append("label")
                                            .attr("for", "xmin-text")
                                            .text("x axis limits:");

                                        this._elements.xmin_text = xaxis.append("input")
                                            .attr("id", "xmin-text")
                                            .attr("type", "text")
                                            .attr("value", this.xmin)
                                            .style("width", "50px")
                                            .on("change", function() {$("#axes-input").axes_input("change_axis_limits", this.value, null, null)});

                                        this._elements.xmax_text = xaxis.append("input")
                                            .attr("id", "xmax-text")
                                            .attr("type", "text")
                                            .attr("value", this.xmax)
                                            .style("width", "50px")
                                            .style("margin-left", "5px")
                                            .on("change", function() {$("#axes-input").axes_input("change_axis_limits", null, this.value, null)});

                                        yaxis.append("label")
                                            .attr("for", "ymax-text")
                                            .text("y axis max:");

                                        this._elements.ymax_text = yaxis.append("input")
                                            .attr("id", "ymax-text")
                                            .attr("type", "text")
                                            .attr("value", this.ymax)
                                            .style("width", "40px")
                                            .on("change", function() {$("#axes-input").axes_input("change_axis_limits", null, null, this.value)})
                                    },

                                    change_axis_limits: function(xmin, xmax, ymax, change_plot=true) {
                                        if (xmin !== null) {
                                            this.xmin = xmin;
                                        };
                                        if (xmax !== null) {
                                            this.xmax = xmax;
                                        };
                                        if (ymax !== null) {
                                            this.ymax = ymax;
                                        };

                                        this._elements.xmin_text.node().value = this.xmin;
                                        this._elements.xmax_text.node().value = this.xmax;
                                        this._elements.ymax_text.node().value = this.ymax;

                                        if (change_plot) {
                                            $("#main-plot").main_plot("scale_axes", this.xmin, this.xmax, this.ymax);
                                            $("#settings-table").settings_table("plot_all_composites")
                                        }
                                    }
                                });

                                $("#axes-input").axes_input()
                            })
                        </script>
                        <div class="col-4 text-right">
                            <input type="button" id="autoscale-axes-button" value="Autoscale axes">
                            <script>
                                $(function() {
                                    d3.select("#autoscale-axes-button").on("click", function() {
                                        $("#settings-table").settings_table("autoscale_axes")
                                    })
                                })
                            </script>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="row">
                        <div class="col text-right">
                            <input type="button" id="reset-plot-button" value="Reset plot">
                            <script>
                                $(function() {
                                    d3.select("#reset-plot-button").on("click", reset)
                                })
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-4" style="overflow:auto; height:50vh; padding-right:31px;">
                    <div class="row">
                        <div class="col-6">
                            <h4>Composite metadata</h4>
                        </div>
                        <div class="col-6 text-right">
                            <input type="button" id="import-metadata-button" value="Import metadata from PEGR">
                            <div id="import-metadata-form" class="form-popup" style="display:none;">
                                <div class="row">
                                    <div class="col">
                                        <label for="pegr-api-key-input">PEGR API key:</label>
                                        <input type="password" id="pegr-api-key-input" style="width:200px;">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label for="email-input">Email:</label>
                                        <input type="text" id="email-input" style="width:200px;">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <input type="button" id="import-metadata-submit-button" value="Submit">
                                        <input type="button" id="import-metadata-cancel-button" value="Cancel">
                                    </div>
                                </div>
                            </div>
                            <script>
                                $(function() {
                                    d3.select("#import-metadata-button").on("click", function() {
                                        d3.select("#import-metadata-form").style("display", null)
                                    });

                                    d3.select("#import-metadata-submit-button").on("click", function() {
                                        let api_key = d3.select("#pegr-api-key-input").node().value,
                                            email = d3.select("#email-input").node().value;
                                        $("#metadata-table").metadata_table("import_metadata_from_pegr", api_key, email);
                                        d3.select("#import-metadata-form").style("display", "none")
                                    });

                                    d3.select("#import-metadata-cancel-button").on("click", function() {
                                        d3.select("#import-metadata-form").style("display", "none")
                                    })
                                })
                            </script>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <table id="metadata-table" class="table"></table>
                            <script>
                                $(function() {
                                    // Metadata table widget
                                    $.widget("composite_plot.metadata_table", {
                                        // Base columns always present in the table
                                        basecols: [
                                            {name: "target", label: "Target", show: false},
                                            {name: "antibody", label: "Antibody", show: false},
                                            {name: "strain", label: "Strain", show: false},
                                            {name: "genetic-modification", label: "Genetic modification", show: false},
                                            {name: "growth-media", label: "Growth media", show: false},
                                            {name: "treatments", label: "Treatments", show: false},
                                            {name: "assay", label: "Assay", show: false},
                                            {name: "dedup-reads", label: "Dedup reads", show: false}
                                        ],
                                        customcols: [],

                                        // Counter for the number of fields added
                                        field_name_counter: 0,

                                        _elements: {
                                            header: null,
                                            fields: [],
                                            tbody: null,
                                            rows: []
                                        },

                                        // Create the table
                                        _create: function() {
                                            let table = d3.select(this.element.context),
                                                header = table.append("thead")
                                                    .append("tr");
                                            this._elements.header = header;

                                            // Add the ID column
                                            header.append("th")
                                                .attr("id", "header-ids")
                                                .append("div")
                                                    .text("IDs");

                                            // Add the base columns
                                            for (let col of this.basecols) {
                                                header.append("th")
                                                    .attr("id", "header-" + col.name)
                                                    .style("display", col.show ? null : "none")
                                                    .append("div")
                                                        .text(col.label);
                                            };

                                            // Add button to add a field
                                            let add_field = header.append("th")
                                                .attr("id", "add-field")
                                                .classed("text-center", true)
                                                .attr("title", "Add field"),
                                                add_field_icon = add_field.append("svg")
                                                    .classed("add-field-icon", true)
                                                    .attr("baseProfile", "full")
                                                    .attr("viewBox", "-200 -200 400 400")
                                                    .attr("version", "1.1")
                                                    .attr("xmlns", "http://www.w3.org/2000/svg")
                                                    .style("height", "20px")
                                                    .style("width", "20px")
                                                    .append("g");
                                            add_field_icon.append("circle")
                                                .attr("cx", 0)
                                                .attr("cy", 0)
                                                .attr("r", 200)
                                                .attr("fill", "#468C00");
                                            add_field_icon.append("polygon")
                                                .attr("points", "-130,30 -30,30 -30,130 30,130 30,30 130,30 130,-30 30,-30 30,-130 -30,-130 -30,-30 -130,-30")
                                                .attr("fill", "#FFFFFF");

                                            // Add dropdown menu
                                            let dropdown = add_field.append("div")
                                                .classed("dropdown", true);
                                            dropdown.selectAll("div")
                                                .data(this.basecols)
                                                .join("div")
                                                    .attr("id", d => "dropdown-" + d.name)
                                                    .classed("dropdown-element", true)
                                                    .classed("selected", d => d.show)
                                                    .text(d => d.label)
                                                    .each(function(d, i, e) {
                                                        d3.select(e[i]).on("click", function() {
                                                            d.show = !d.show;
                                                            $("#metadata-table").metadata_table("toggle_base_field", d.name, d.show)
                                                        })
                                                    });
                                            dropdown.append("div")
                                                .attr("id", "add-custom-field")
                                                .classed("dropdown-element", true)
                                                .text("+Custom field")
                                                .on("click", function() {$("#metadata-table").metadata_table("add_field")});

                                            let tbody = table.append("tbody");
                                            this._elements.tbody = tbody;

                                            // Add button to add a row
                                            let add_row = tbody.append("tr")
                                                .attr("id", "add-row")
                                                .on("click", function() {
                                                $("#metadata-table").metadata_table("add_row");
                                                // Link rows in settings table to metadata table
                                                $("#settings-table").settings_table("add_row")
                                            });
                                            add_row.append("td")
                                                .attr("colspan", 100)
                                                .text("Add entry")
                                        },

                                        // Toggle a base field
                                        toggle_base_field: function(name, show) {
                                            this._elements.header.select("#header-" + name)
                                                .style("display", show ? null : "none");
                                            d3.select("#dropdown-" + name)
                                                .classed("selected", show);

                                            // Toggle field in all rows
                                            for (let row of this._elements.rows) {
                                                $(row.node()).metadata_row("toggle_field", name, show)
                                            }
                                        },

                                        // Add a field to the table
                                        add_field: function() {
                                            let new_field = this._elements.header.insert("th", "#add-field"),
                                                field_idx = this._elements.fields.length;
                                            $(new_field.node()).metadata_field({idx: field_idx, name: "Field " + this.field_name_counter++});

                                            // Add new field to all rows
                                            for (let row of this._elements.rows) {
                                                $(row.node()).metadata_row("add_field", field_idx)
                                            };

                                            this.customcols.push(field_idx);
                                            this._elements.fields.push(new_field)
                                        },

                                        // Remove a field from the table
                                        remove_field: function(i) {
                                            // Remove field from all rows
                                            for (let row of this._elements.rows) {
                                                $(row.node()).metadata_row("remove_field", i)
                                            }

                                            this._elements.fields.splice(i, 1);

                                            // Rename all fields after the removed one
                                            this.customcols = [...Array.from(this._elements.fields, (d, i) => i)];
                                            for (let j in this._elements.fields) {
                                                $(this._elements.fields[j].node()).metadata_field("set_index", j)
                                            }
                                        },

                                        // Add a row to the table
                                        add_row: function() {
                                            let new_row = this._elements.tbody.insert("tr", "#add-row");
                                            $(new_row.node()).metadata_row({idx: this._elements.rows.length, basecols: this.basecols, customcols: this.customcols});
                                            this._elements.rows.push(new_row)
                                        },

                                        // Remove a row from the table
                                        remove_row: function(i) {
                                            this._elements.rows.splice(i, 1);

                                            // Rename all rows after the removed one
                                            for (let j in this._elements.rows) {
                                                $(this._elements.rows[j].node()).metadata_row("set_index", j)
                                            }
                                        },

                                        insert_row: function(drag_idx, drop_idx, insert_after) {
                                            if (drag_idx !== drop_idx) {
                                                let drag_row = this._elements.rows[drag_idx],
                                                    drop_row = this._elements.rows[drop_idx];
                                                if (insert_after) {
                                                    $(drag_row.node()).insertAfter(drop_row.node());
                                                } else {
                                                    $(drag_row.node()).insertBefore(drop_row.node());
                                                };

                                                this._elements.rows.splice(drag_idx, 1);
                                                this._elements.rows.splice(drop_idx + insert_after - (drop_idx > drag_idx), 0, drag_row);

                                                // Update the indices of the remaining rows
                                                for (let i in this._elements.rows) {
                                                    $(this._elements.rows[i].node()).metadata_row("set_index", i)
                                                }
                                            }
                                        },

                                        add_id: function(i, id) {
                                            $(this._elements.rows[i].node()).metadata_row("add_id", id)
                                        },

                                        // Highlight a row
                                        highlight_row: function(i) {
                                            $(this._elements.rows[i].node()).metadata_row("highlight")
                                        },

                                        // Unhighlight a row
                                        unhighlight_row: function(i) {
                                            $(this._elements.rows[i].node()).metadata_row("unhighlight")
                                        },

                                        reset_row(i) {
                                            $(this._elements.rows[i].node()).metadata_row("reset")
                                        },

                                        import_metadata_from_pegr: async function(api_key, email) {
                                            let test = $.post(
                                                'https://thanos.vmhost.psu.edu/pegr/api/fetchSampleData?apiKey=' + api_key,
                                                {
                                                    userEmail: email,
                                                    id: 1
                                                }
                                            );
                                            try {
                                                await test;
                                                for (let row of this._elements.rows) {
                                                    $(row.node()).metadata_row("fetch_metadata_for_pegr_ids", api_key, email)
                                                }
                                            } catch {
                                                if (test.status === 401) {
                                                    alert("Invalid credentials")
                                                } else {
                                                    alert("Error fetching metadata from PEGR")
                                                }
                                            }
                                        },

                                        export: function() {
                                            let data = {
                                                basecols: this.basecols,
                                                customcols: this._elements.fields.map(d => d.select("div").text()),
                                                rows: this._elements.rows.map(d => $(d.node()).metadata_row("export"))
                                            };

                                            return data
                                        },

                                        import: function(data) {
                                            // Add the base fields
                                            for (let i in data.basecols) {
                                                let col = data.basecols[i];
                                                this.toggle_base_field(col.name, col.show);
                                                this.basecols[i].show = col.show
                                            };

                                            // Add the custom fields
                                            for (let i in data.customcols) {
                                                this.add_field();
                                                $(this._elements.fields[i].node()).metadata_field("set_name", data.customcols[i])
                                            };

                                            // Add the rows
                                            for (let i in data.rows) {
                                                this.add_row();
                                                $(this._elements.rows[i].node()).metadata_row("import", data.rows[i])
                                            }
                                        },

                                        reset: function() {
                                            d3.select(this.element.context).selectAll("*").remove();
                                            this.field_name_counter = 0;
                                            this.basecols = [
                                                {name: "target", label: "Target", show: false},
                                                {name: "antibody", label: "Antibody", show: false},
                                                {name: "strain", label: "Strain", show: false},
                                                {name: "genetic-modification", label: "Genetic modification", show: false},
                                                {name: "growth-media", label: "Growth media", show: false},
                                                {name: "treatments", label: "Treatments", show: false},
                                                {name: "assay", label: "Assay", show: false},
                                                {name: "dedup-reads", label: "Dedup reads", show: false}
                                            ];
                                            this.customcols = [];
                                            this._elements.fields = [];
                                            this._elements.rows = [];
                                            this._create()
                                        }
                                    });

                                    // Metadata field widget
                                    $.widget("composite_plot.metadata_field", {
                                        options: {
                                            idx: null,
                                            name: null
                                        },

                                        // Create the field
                                        _create: function() {
                                            let field = d3.select(this.element.context)
                                                .style("position", "relative");
                                            field.append("div")
                                                .attr("contenteditable", true)
                                                .text(this.options.name);

                                            // Add button to remove the field
                                            let remove_field = field.append("svg")
                                                .classed("remove-field-icon", true)
                                                .attr("baseProfile", "full")
                                                .attr("viewBox", "-200 -200 400 400")
                                                .attr("version", "1.1")
                                                .attr("xmlns", "http://www.w3.org/2000/svg")
                                                .on("click", function() {$(field.node()).metadata_field("destroy")});
                                            remove_field.append("g")
                                                    .append("polygon")
                                                        .attr("points", "-130,30 -30,30 -30,130 30,130 30,30 130,30 130,-30 30,-30 30,-130 -30,-130 -30,-30 -130,-30")
                                                        .attr("fill", "#000000")
                                                        .attr("transform", "rotate(45)");
                                        },

                                        // Remove the field
                                        _destroy: function() {
                                            $("#metadata-table").metadata_table("remove_field", this.options.idx);
                                            d3.select(this.element.context).remove()
                                        },

                                        // Set the field index
                                        set_index: function(i) {
                                            this.options.idx = i
                                        },

                                        set_name: function(name) {
                                            d3.select(this.element.context).select("div").text(name)
                                        }
                                    });

                                    // Metadata row widget
                                    $.widget("composite_plot.metadata_row", {
                                        ids: null,

                                        options: {
                                            idx: null,
                                            basecols: [],
                                            customcols: []
                                        },

                                        // Create the row
                                        _create: function() {
                                            this.ids = [];

                                            let row = d3.select(this.element.context)
                                                .classed("content-row", true);
                                            row.selectAll("td")
                                                .data(this.options.basecols)
                                                .join("td")
                                                    .attr("class", d => "content-field field-" + d.name)
                                                    .style("display", d => d.show ? null : "none")
                                                    .append("div")
                                                        .attr("contenteditable", true)
                                                        .on("input", function() {d3.select(this.parentNode).classed("mismatch", false)});
                                            this.options.customcols.forEach(d => {
                                                row.append("td")
                                                    .classed("content-field", true)
                                                    .classed("field-" + d, true)
                                                    .append("div")
                                                        .attr("contenteditable", true)
                                            });
                                            row.insert("td", "td")
                                                .attr("class", "content-field field-ids")
                                                .append("div");

                                            // Add button to remove the row
                                            let remove_row = row.append("td")
                                                .classed("remove-row", true)
                                                .classed("text-center", true)
                                                .attr("title", "Remove row")
                                                .on("click", function() {$(row.node()).metadata_row("destroy")}),
                                                remove_row_icon = remove_row.append("svg")
                                                .classed("remove-row-icon", true)
                                                .attr("baseProfile", "full")
                                                .attr("viewBox", "-200 -200 400 400")
                                                .attr("version", "1.1")
                                                .attr("xmlns", "http://www.w3.org/2000/svg")
                                                .style("height", "20px")
                                                .style("width", "20px")
                                                .append("g");
                                            remove_row_icon.append("circle")
                                                .attr("cx", 0)
                                                .attr("cy", 0)
                                                .attr("r", 200)
                                                .attr("fill", "#DD0000");
                                            remove_row_icon.append("polygon")
                                                .attr("points", "-130,30 -30,30 -30,130 30,130 30,30 130,30 130,-30 30,-30 30,-130 -30,-130 -30,-30 -130,-30")
                                                .attr("fill", "#FFFFFF")
                                                .attr("transform", "rotate(45)")
                                        },

                                        // Remove the row
                                        _destroy: function() {
                                            $("#metadata-table").metadata_table("remove_row", this.options.idx);
                                            // Link rows in settings table to metadata table
                                            $("#settings-table").settings_table("remove_row", this.options.idx);
                                            // Link composites in plot to metadata table
                                            $("#main-plot").main_plot("remove_composite", this.options.idx);
                                            d3.select(this.element.context).remove()
                                        },

                                        // Toggle a base field
                                        toggle_field: function(name, show) {
                                            d3.select(this.element.context).select("td.field-" + name)
                                                .style("display", show ? null : "none")
                                        },

                                        // Add a field to the row
                                        add_field: function(i) {
                                            d3.select(this.element.context).insert("td", "td.remove-row")
                                                .classed("custom-field", true)
                                                .classed("content-field", true)
                                                .classed("field-" + i, true)
                                                .append("div")
                                                    .attr("contenteditable", true)
                                        },

                                        // Remove a field from the row
                                        remove_field: function(i) {
                                            let row = d3.select(this.element.context);
                                            row.select("td.field-" + i).remove();

                                            // Rename the remaining fields
                                            row.selectAll("td.custom-field").join()
                                                .attr("class", (d, i) => "custom-field field-" + i)
                                        },

                                        // Add ID to row
                                        add_id: function(id) {
                                            this.ids.push(id);
                                            d3.select(this.element.context).select("td.field-ids div").text(this.ids.join(", "))
                                        },

                                        // Set the row index
                                        set_index: function(i) {
                                            this.options.idx = i
                                        },

                                        // Highlight row
                                        highlight: function() {
                                            d3.select(this.element.context).classed("mouse-highlight", true)
                                        },

                                        // Unhighlight row
                                        unhighlight: function() {
                                            d3.select(this.element.context).classed("mouse-highlight", false)
                                        },

                                        fetch_metadata_for_pegr_ids: async function(api_key, email) {
                                            let base_metadata = [
                                                {key: "antibody", field_name: "antibody", val: new Set()},
                                                {key: "assay", field_name: "assay", val: new Set()},
                                                {key: "geneticModification", field_name: "genetic-modification", val: new Set()},
                                                {key: "growthMedia", field_name: "growth-media", val: new Set()},
                                                {key: "strain", field_name: "strain", val: new Set()},
                                                {key: "target", field_name: "target", val: new Set()},
                                                {key: "treatments", field_name: "treatments", val: new Set()}
                                            ],
                                                dedup_reads = [];
                                            for (let pegr_id of this.ids) {
                                                await $.post(
                                                    'https://thanos.vmhost.psu.edu/pegr/api/fetchSampleData?apiKey=' + api_key,
                                                    {
                                                        userEmail: email,
                                                        id: pegr_id
                                                    },
                                                    function(response) {
                                                        for (let base_field of base_metadata) {
                                                            let val = response.data[0][base_field.key];
                                                            if (val) {
                                                                base_field.val.add(val)
                                                            }
                                                        };

                                                        dedup_reads.push(response.data[0].experiments[0].alignments[0].dedupUniquelyMappedReads)
                                                    }
                                                ).fail(
                                                    function() {
                                                        alert("PEGR ID " + pegr_id + " not found")
                                                    }
                                                )
                                            };
                                            for (let base_field of base_metadata) {
                                                let val;
                                                if (base_field.val.size === 0) {
                                                    val = ""
                                                } else if (base_field.val.size === 1) {
                                                    val = base_field.val.values().next().value
                                                } else {
                                                    val = "{(" + Array.from(base_field.val).join("), (") + ")}";
                                                    d3.select(this.element.context).select("td.field-" + base_field.field_name).classed("mismatch", true)
                                                };
                                                d3.select(this.element.context).select("td.field-" + base_field.field_name + " div").text(val)
                                            };
                                            d3.select(this.element.context).select("td.field-dedup-reads div").text(dedup_reads.join(", "))
                                        },

                                        reset: function() {
                                            this.ids = [];

                                            d3.select(this.element.context).selectAll("td.content-field").join()
                                                .select("div")
                                                    .text("");
                                            d3.select(this.element.context).selectAll("td.content-field").classed("mismatch", false)
                                        },

                                        export: function() {
                                            return d3.select(this.element.context).selectAll("td.content-field").nodes().map(d => d3.select(d).select("div").text())
                                        },

                                        import: function(data) {
                                            this.ids = data[0].split(", ");

                                            d3.select(this.element.context).selectAll("td.content-field").data(data).join()
                                                .select("div")
                                                    .text(d => d);

                                            // Link rows in settings table to metadata table
                                            $("#settings-table").settings_table("update_ids", this.options.idx, data[0])
                                        }
                                    });

                                    $("#metadata-table").metadata_table()
                                })
                            </script>
                        </div>
                    </div>

                </div>
                <div class="col-8">
                    <div class="row">
                        <div class="col">
                            <svg id="main-plot" baseProfile="full" viewBox="0 0 550 300" version="1.1" xmlns="http://www.w3.org/2000/svg" font-family="Helvetica" style="height: 50vh; max-width: 100%; overflow: visible; display: inline-block;"></svg>
                            <script>
                                $(function() {
                                    // Main plot widget
                                    $.widget("composite_plot.main_plot", {
                                        title: "Composite plot",
                                        xmin: -500,
                                        xmax: 500,
                                        ymax: 1,
                                        xlabel: "Position (bp)",
                                        ylabel: "Occupancy (AU)",
                                        width: 550,
                                        height: 300,
                                        margins: {top: 30, right: 170, bottom: 35, left: 30},
                                        xscale: null,
                                        yscale: null,
                                        opacity: .7,
                                        smoothing: 7,
                                        bp_shift: 0,
                                        combined: false,

                                        _elements: {
                                            main_plot: null,
                                            xmin: null,
                                            xmax: null,
                                            ymin: null,
                                            ymax: null,
                                            title: null,
                                            xlabel: null,
                                            ylabel: null,
                                            ylabel_suffix: "",
                                            midaxis_top: null,
                                            midaxis_bottom: null,
                                            tooltip: null,
                                            composites: [],
                                            legend: null,
                                            legend_items: []
                                        },

                                        _create: function() {
                                            let xscale = d3.scaleLinear()
                                                .domain([this.xmin, this.xmax])
                                                .range([this.margins.left, this.width - this.margins.right]);
                                            this.xscale = xscale;
                                            let yscale = d3.scaleLinear()
                                                .domain([-this.ymax, this.ymax])
                                                .range([this.height - this.margins.bottom, this.margins.top]);
                                            this.yscale = yscale;

                                            let main_plot = d3.select(this.element.context);
                                            this._elements.main_plot = main_plot;
                                            main_plot.append("g")
                                                .attr("transform", "translate(0 " + (this.height - this.margins.bottom) + ")")
                                                .call(d3.axisTop(xscale).tickFormat(""))
                                            main_plot.append("g")
                                                .attr("transform", "translate(0 " + this.margins.top + ")")
                                                .call(d3.axisBottom(xscale).tickFormat(""))
                                            main_plot.append("g")
                                                .attr("transform", "translate(" + this.margins.left + " 0)")
                                                .call(d3.axisRight(yscale).tickFormat(""));
                                            main_plot.append("g")
                                                .attr("transform", "translate(" + (this.width - this.margins.right) + " 0)")
                                                .call(d3.axisLeft(yscale).tickFormat(""));
                                            this._elements.midaxis_bottom = main_plot.append("g")
                                                .attr("transform", "translate(0 " + ((this.margins.top + this.height - this.margins.bottom) / 2) + ")")
                                                .call(d3.axisBottom(xscale).tickFormat(""));
                                            this._elements.midaxis_top = main_plot.append("g")
                                                .attr("transform", "translate(0 " + ((this.margins.top + this.height - this.margins.bottom) / 2) + ")")
                                                .call(d3.axisTop(xscale).tickFormat(""));
                                            this._elements.xmin = main_plot.append("text")
                                                .attr("x", this.margins.left)
                                                .attr("y", this.height - this.margins.bottom + 15)
                                                .style("text-anchor", "middle")
                                                .attr("font-size", "10px")
                                                .text(this.xmin)
                                            this._elements.xmax = main_plot.append("text")
                                                .attr("x", this.width - this.margins.right)
                                                .attr("y", this.height - this.margins.bottom + 15)
                                                .style("text-anchor", "middle")
                                                .attr("font-size", "10px")
                                                .text(this.xmax)
                                            this._elements.ymin = main_plot.append("text")
                                                .attr("x", 20)
                                                .attr("y", this.height - this.margins.bottom)
                                                .attr("transform", "rotate(-90 20 " + (this.height - this.margins.bottom) + ")")
                                                .style("text-anchor", "middle")
                                                .attr("font-size", "10px")
                                                .text(-this.ymax)
                                            this._elements.ymax = main_plot.append("text")
                                                .attr("x", 20)
                                                .attr("y", this.margins.top)
                                                .attr("transform", "rotate(-90 20 " + (this.margins.top) + ")")
                                                .style("text-anchor", "middle")
                                                .attr("font-size", "10px")
                                                .text(this.ymax)
                                            this._elements.title = main_plot.append("g");
                                            $(this._elements.title.node()).editable_svg_text({
                                                label: "title",
                                                text: this.title,
                                                x: (this.width + this.margins.left - this.margins.right) / 2,
                                                y: 20,
                                                font_size: 16
                                            });
                                            this._elements.xlabel = main_plot.append("g");
                                            $(this._elements.xlabel.node()).editable_svg_text({
                                                label: "xlabel",
                                                text: this.xlabel,
                                                x: (this.width + this.margins.left - this.margins.right) / 2,
                                                y: this.height - 15,
                                                font_size: 12
                                            });
                                            this._elements.ylabel = main_plot.append("g");
                                            $(this._elements.ylabel.node()).editable_svg_text({
                                                label: "ylabel",
                                                text: this.ylabel,
                                                x: 15,
                                                y: (this.height + this.margins.top - this.margins.bottom) / 2,
                                                font_size: 12,
                                                rotation: "vertical"
                                            });

                                            this._elements.legend = main_plot.append("g")
                                                .attr("transform", "translate(" + (this.width - this.margins.right + 25) + " " + this.margins.top + ")");

                                            this._elements.tooltip = main_plot.append("g")
                                                .attr("id", "composite-plot-tooltip")
                                        },

                                        _destroy: function() {
                                            this._elements.main_plot.remove()
                                        },

                                        add_composite: function(name, color) {
                                            let composite = this._elements.main_plot.insert("g", "g.composite")
                                                .classed("composite", true);

                                            composite.append("defs")
                                                .append("linearGradient")
                                                    .attr("id", "composite-gradient-" + this._elements.composites.length)
                                                    .classed("composite-gradient", true)
                                                    .attr("x1", "0%")
                                                    .attr("x2", "0%");

                                            composite.append("path")
                                                .classed("composite-line", true)
                                                .attr("fill", "none")
                                                .attr("stroke-width", 1)
                                                .attr("d", "");

                                            composite.append("polygon")
                                                .classed("composite-fill", true)
                                                .attr("fill", "url(#composite-gradient-" + this._elements.composites.length + ")")
                                                .attr("stroke", "none");

                                            this._elements.composites.push(composite);

                                            let legend_element = this._elements.legend.append("g")
                                                .classed("legend-element", true)
                                                .style("display", "none");

                                            legend_element.append("rect")
                                                .attr("width", 15)
                                                .attr("height", 15)
                                                .attr("stroke", "#000000")
                                                .attr("stroke-width", 1)
                                                .attr("fill", color);
                                            legend_element.append("text")
                                                .attr("x", 20)
                                                .attr("y", 10)
                                                .attr("font-size", "10px")
                                                .text(name);

                                            this._elements.legend_items.push(legend_element)
                                        },

                                        remove_composite: function(i) {
                                            this._elements.composites[i].remove();
                                            this._elements.composites.splice(i, 1);

                                            this._elements.legend_items[i].remove();
                                            this._elements.legend_items.splice(i, 1);

                                            this.update_legend()
                                        },

                                        reset_composite: function(i) {
                                            let composite = this._elements.composites[i]
                                                .classed("plotted", false)
                                                .style("display", "none");

                                            composite.select("path")
                                                .attr("d", "");
                                            composite.select("polygon")
                                                .attr("points", "");

                                            this.change_name(i, "Composite " + i);
                                            this.update_legend()
                                        },

                                        plot_composite: function(xmin, xmax, sense, anti, scale, color, i, opacity, smoothing, bp_shift, hide) {
                                            let composite = this._elements.composites[i]
                                                .classed("plotted", !hide)
                                                .style("display", hide ? "none" : null),
                                                xdomain = Array.from({length: xmax - xmin + 1}, (d, j) => j + xmin);

                                            opacity = opacity === false ? this.opacity : opacity;
                                            smoothing = smoothing === false ? this.smoothing : smoothing;
                                            bp_shift = bp_shift === false ? this.bp_shift : bp_shift;

                                            if (this.combined) {
                                                let shifted_xdomain = xdomain.filter(x => x - bp_shift >= xdomain[0] && x - bp_shift <= xdomain[xdomain.length - 1]
                                                        && x + bp_shift >= xdomain[0] && x + bp_shift <= xdomain[xdomain.length - 1]),
                                                    shifted_sense = sense.filter((_, j) => xdomain[j] + bp_shift >= shifted_xdomain[0]
                                                        && xdomain[j] + bp_shift <= shifted_xdomain[shifted_xdomain.length - 1]),
                                                    shifted_anti = anti.filter((_, j) => xdomain[j] - bp_shift >= shifted_xdomain[0]
                                                        && xdomain[j] - bp_shift <= shifted_xdomain[shifted_xdomain.length - 1]),
                                                    combined_occupancy = shifted_sense.map((d, j) => d + shifted_anti[j]),
                                                    {new_xdomain, new_occupancy: smoothed_occupancy} = sliding_window(shifted_xdomain, combined_occupancy, smoothing),
                                                    truncated_xdomain = new_xdomain.filter(x => x >= this.xmin && x <= this.xmax),
                                                    scaled_occupancy = smoothed_occupancy.filter((_, j) => new_xdomain[j] >= this.xmin && new_xdomain[j] <= this.xmax)
                                                        .map(d => d * scale);

                                                composite.select(".composite-gradient")
                                                    .attr("y1", "0%")
                                                    .attr("y2", "100%")
                                                    .selectAll("stop")
                                                        .data([0, 1])
                                                        .join("stop")
                                                            .attr("offset", d => d)
                                                            .attr("stop-color", color)
                                                            .attr("stop-opacity", d => (1 - d) * opacity);

                                                composite.select(".composite-line")
                                                    .datum(truncated_xdomain)
                                                    .attr("stroke", color)
                                                    .attr("d", d3.line()
                                                        .x(d => this.xscale(d))
                                                        .y((_, j) => this.yscale(scaled_occupancy[j]))
                                                    );

                                                composite.select(".composite-fill")
                                                    .attr("points", truncated_xdomain.map((d, j) => this.xscale(d) + "," + this.yscale(scaled_occupancy[j])).join(" ") + " "
                                                        + this.xscale(truncated_xdomain[truncated_xdomain.length - 1]) + "," + this.yscale(0) + " "
                                                        + this.xscale(truncated_xdomain[0]) + "," + this.yscale(0))
                                            } else {
                                                let sensemax = Math.max(...sense),
                                                    antimax = Math.max(...anti),
                                                    ymax = Math.max(sensemax, antimax),
                                                    {new_xdomain, new_occupancy: smoothed_sense} = sliding_window(xdomain, sense, smoothing),
                                                    {new_occupancy: smoothed_anti} = sliding_window(xdomain, anti, smoothing),
                                                    truncated_sense_domain = new_xdomain.map(x => x + bp_shift).filter(x => x >= this.xmin && x <= this.xmax),
                                                    truncated_anti_domain = new_xdomain.map(x => x - bp_shift).filter(x => x >= this.xmin && x <= this.xmax),
                                                    scaled_sense = smoothed_sense.filter((_, j) => new_xdomain[j] + bp_shift >= this.xmin
                                                        && new_xdomain[j] + bp_shift <= this.xmax).map(d => d * scale),
                                                    scaled_anti = smoothed_anti.filter((_, j) => new_xdomain[j] - bp_shift >= this.xmin
                                                        && new_xdomain[j] - bp_shift <= this.xmax).map(d => d * scale);

                                                composite.select(".composite-gradient")
                                                    .attr("y1", (ymax - antimax) / (2 * ymax))
                                                    .attr("y2", (ymax + sensemax) / (2 * ymax))
                                                    .selectAll("stop")
                                                        .data([{offset: 0, opacity: opacity}, {offset: .5, opacity: 0}, {offset: 1, opacity: opacity}])
                                                        .join("stop")
                                                            .attr("offset", d => d.offset)
                                                            .attr("stop-color", color)
                                                            .attr("stop-opacity", d => d.opacity);

                                                composite.select(".composite-line")
                                                    .attr("stroke", color)
                                                    .attr("d", "M" + truncated_sense_domain.map((d, j) => this.xscale(d) + " " + this.yscale(scaled_sense[j])).join("L")
                                                        + "M" + truncated_anti_domain.map((d, j) => this.xscale(d) + " " + this.yscale(-scaled_anti[j])).join("L"));

                                                composite.select(".composite-fill")
                                                    .attr("points", this.xscale(truncated_sense_domain[0]) + "," + this.yscale(0) + " "
                                                        + truncated_sense_domain.map((d, j) => this.xscale(d) + "," + this.yscale(scaled_sense[j])).join(" ") + " "
                                                        + this.xscale(truncated_sense_domain[truncated_sense_domain.length - 1]) + "," + this.yscale(0) + " "
                                                        + this.xscale(truncated_anti_domain[truncated_anti_domain.length - 1]) + "," + this.yscale(0) + " "
                                                        + truncated_anti_domain.map((d, j) => this.xscale(d) + "," + this.yscale(-scaled_anti[j])).reverse().join(" ") + " "
                                                        + this.xscale(truncated_anti_domain[0]) + "," + this.yscale(0))
                                            }
                                        },

                                        scale_axes: function(xmin, xmax, ymax, allow_shrink=true, change_input=false) {
                                            if (xmin !== undefined && xmax !== undefined && ymax !== undefined) {
                                                if (allow_shrink) {
                                                    this.xmin = xmin;
                                                    this.xmax = xmax;
                                                    this.ymax = change_input ? ymax : ymax / (this.combined + 1)
                                                } else {
                                                    this.xmin = Math.min(this.xmin, xmin);
                                                    this.xmax = Math.max(this.xmax, xmax);
                                                    this.ymax = Math.max(this.ymax, ymax) / (change_input ? 1 : this.combined + 1)
                                                }
                                            };

                                            this._elements.xmin.text(this.xmin);
                                            this._elements.xmax.text(this.xmax);
                                            let round_exp = 1 - Math.floor(Math.log10(this.ymax)),
                                                round_factor = 10 ** round_exp,
                                                ymax_factor = this.combined ? 2 : 1;
                                            if (round_exp > -2 && round_exp < 2) {
                                                this._elements.ylabel_suffix = ""
                                                this._elements.ymin.text(this.combined ? "" : Math.round(-this.ymax * round_factor) / round_factor);
                                                this._elements.ymax.text(Math.round(this.ymax * round_factor * ymax_factor) / round_factor)
                                            } else {
                                                this._elements.ylabel_suffix = " x10 <tspan font-size=\"8px\" baseline-shift=\"super\">" + (round_exp - 1) + "</tspan>";
                                                this._elements.ymin.text(this.combined ? "" : Math.round(-this.ymax * round_factor) / 10);
                                                this._elements.ymax.text(Math.round(this.ymax * round_factor * ymax_factor) / 10)
                                            };

                                            this.xscale = d3.scaleLinear()
                                                .domain([this.xmin, this.xmax])
                                                .range([this.margins.left, this.width - this.margins.right]);
                                            this.yscale = d3.scaleLinear()
                                                .domain([-this.ymax * !this.combined, this.ymax * ymax_factor])
                                                .range([this.height - this.margins.bottom, this.margins.top]);

                                            this._elements.ylabel.select("text").html(this.ylabel + this._elements.ylabel_suffix);

                                            if (change_input) {
                                                $("#axes-input").axes_input("change_axis_limits", this.xmin, this.xmax, this.ymax * ymax_factor)
                                            }
                                        },

                                        update_legend: function() {
                                            this._elements.legend.selectAll("g")
                                                .data(this._elements.composites.map((y => comp => [y += comp.classed("plotted") * 24, comp.classed("plotted") ? null : "none"])(-24)))
                                                .join("g")
                                                    .attr("transform", d => "translate(0," + d[0] + ")")
                                                    .style("display", d => d[1])
                                        },

                                        change_label: function(label, text) {
                                            this[label] = text
                                        },

                                        change_name: function(i, name) {
                                            this._elements.legend_items[i].select("text")
                                                .text(name)
                                        },

                                        change_color: function(i, color) {
                                            let composite = this._elements.composites[i];
                                            composite.select(".composite-gradient")
                                                .selectAll("stop")
                                                    .attr("stop-color", color);
                                            composite.select(".composite-line")
                                                .attr("stroke", color);

                                            this._elements.legend_items[i].select("rect")
                                                .attr("fill", color);
                                        },

                                        change_opacity: function(i, opacity) {
                                            if (i === true) {
                                                this.opacity = opacity;
                                                $("#settings-table").settings_table("plot_all_composites")
                                            } else {
                                                this._elements.composites[i].select(".composite-gradient")
                                                    .selectAll("stop")
                                                        .attr("stop-opacity", (d, i) => (1 - i % 2) * opacity)
                                            }
                                        },

                                        change_smoothing: function(smoothing) {
                                            this.smoothing = smoothing;

                                            $("#settings-table").settings_table("plot_all_composites")
                                        },

                                        change_bp_shift: function(bp_shift) {
                                            this.bp_shift = bp_shift;

                                            $("#settings-table").settings_table("plot_all_composites")
                                        },

                                        toggle_hide: function(i, hide) {
                                            this._elements.composites[i]
                                                .classed("plotted", !hide)
                                                .style("display", hide ? "none" : null);

                                            this.update_legend()
                                        },

                                        change_order: function(drag_idx, drop_idx, insert_after) {
                                            if (drag_idx !== drop_idx) {
                                                let drag_comp = this._elements.composites[drag_idx],
                                                    drop_comp = this._elements.composites[drop_idx],
                                                    drag_legend_item = this._elements.legend_items[drag_idx],
                                                    drop_legend_item = this._elements.legend_items[drop_idx];
                                                if (insert_after) {
                                                    $(drag_comp.node()).insertBefore(drop_comp.node());
                                                    $(drag_legend_item.node()).insertAfter(drop_legend_item.node())
                                                } else {
                                                    $(drag_comp.node()).insertAfter(drop_comp.node());
                                                    $(drag_legend_item.node()).insertBefore(drop_legend_item.node())
                                                };

                                                this._elements.composites.splice(drag_idx, 1);
                                                this._elements.composites.splice(drop_idx + insert_after - (drop_idx > drag_idx), 0, drag_comp);
                                                this._elements.legend_items.splice(drag_idx, 1);
                                                this._elements.legend_items.splice(drop_idx + insert_after - (drop_idx > drag_idx), 0, drag_legend_item);

                                                this.update_legend()
                                            }
                                        },

                                        toggle_combined: function(combine) {
                                            this.combined = combine;

                                            this._elements.midaxis_top.style("display", combine ? "none" : null);
                                            this._elements.midaxis_bottom.style("display", combine ? "none" : null);

                                            this.scale_axes(undefined, undefined, undefined, true, true);

                                            $("#settings-table").settings_table("plot_all_composites")
                                        },

                                        download_as_svg: function() {
                                            let b64doc = btoa(unescape(encodeURIComponent(this.element.context.outerHTML))),
                                                a = document.createElement("a"),
                                                e = new MouseEvent("click");
                                            a.download = "composite_plot.svg";
                                            a.href = "data:image/svg+xml;base64," + b64doc;
                                            a.dispatchEvent(e)
                                        },

                                        export: function() {
                                            return {title: this.title, xlabel: this.xlabel, ylabel: this.ylabel, opacity: this.opacity,
                                                smoothing: this.smoothing, bp_shift: this.bp_shift, xmin: this.xmin, xmax: this.xmax,
                                                ymax: this.ymax, combined: this.combined}
                                        },

                                        import: function(data) {
                                            this.combined = data.combined;

                                            this.scale_axes(data.xmin, data.xmax, data.ymax, true, true);
                                            $("#opacity-input").opacity_input("change_opacity", data.opacity);
                                            $("#smoothing-input").smoothing_input("change_smoothing", data.smoothing);
                                            $("#shift-input").shift_input("change_shift", data.bp_shift);
                                            d3.select("#combined-checkbox").property("checked", data.combined);

                                            $(this._elements.title.node()).editable_svg_text("change_label", data.title);
                                            $(this._elements.xlabel.node()).editable_svg_text("change_label", data.xlabel);
                                            $(this._elements.ylabel.node()).editable_svg_text("change_label", data.ylabel)
                                        },

                                        reset: function() {
                                            this.combined = false;
                                            this.title = "Composite Plot";
                                            this.xlabel = "Position (bp)";
                                            this.ylabel = "Occupancy (AU)";

                                            $("#axes-input").axes_input("change_axis_limits", -500, 500, 1);
                                            $("#opacity-input").opacity_input("change_opacity", 0.7);
                                            $("#smoothing-input").smoothing_input("change_smoothing", 7);
                                            $("#shift-input").shift_input("change_shift", 0);
                                            d3.select("#combined-checkbox").property("checked", false);

                                            this._elements.main_plot.selectAll("*").remove();
                                            this._elements.composites = [];
                                            this._elements.legend_items = [];
                                            this._create()
                                        }
                                    });

                                    $.widget("composite_plot.editable_svg_text", {
                                        text_label: null,
                                        foreign_object: null,

                                        options: {
                                            label: null,
                                            text: null,
                                            x: null,
                                            y: null,
                                            font_size: null,
                                            rotation: "horizontal"
                                        },

                                        _create: function() {
                                            let label_group = d3.select(this.element.context);
                                            this.text_label = label_group.append("text")
                                                .attr("x", this.options.x)
                                                .attr("y", this.options.y)
                                                .attr("font-size", this.options.font_size)
                                                .attr("transform", "rotate(" + (this.options.rotation === "horizontal" ? 0 : -90 + " " + this.options.x + " " + this.options.y) + ")")
                                                .style("text-anchor", "middle")
                                                .style("cursor", "pointer")
                                                .text(this.options.text)
                                                .on("click", function() {$(label_group.node()).editable_svg_text("toggle_input")});
                                        },

                                        toggle_input: function(ev) {
                                            let label_group = d3.select(this.element.context);
                                            this.text_label.style("display", "none");
                                            this.foreign_object = label_group.append("foreignObject")
                                                .attr("x", this.options.x - 50)
                                                .attr("y", this.options.y - 20)
                                                .attr("width", 100)
                                                .attr("height", 40)
                                                .attr("transform", "rotate(" + (this.options.rotation === "horizontal" ? 0 : -90 + " " + this.options.x + " " + this.options.y) + ")")
                                                .style("text-align", "center");

                                            let input = this.foreign_object.append("input")
                                                .attr("type", "text")
                                                .attr("value", this.options.text)
                                                .style("font-size", "10px");

                                            // This is a hack to make the input box appear
                                            input.node().outerHTML = input.node().outerHTML;

                                            this.foreign_object.select("input")
                                                .on("keypress", function(e) {$(label_group.node()).editable_svg_text("enter_input", e)})
                                                .node().focus()
                                        },

                                        enter_input: function(ev) {
                                            if (ev.keyCode === 13) {
                                                this.foreign_object.remove();

                                                if (ev.target.value.trim().length !== 0) {
                                                    this.change_label(ev.target.value)
                                                }
                                            }
                                        },

                                        change_label: function(new_label) {
                                            this.options.text = new_label;
                                            this.text_label
                                                .style("display", null)
                                                .html(new_label + (this.options.label === "ylabel" ? $("#main-plot").main_plot("instance")._elements.ylabel_suffix : ""));

                                            $("#main-plot").main_plot("change_label", this.options.label, new_label)
                                        }
                                    });

                                    $("#main-plot").main_plot()
                                });
                            </script>
                        </div>
                    </div>
                    <div class="row">
                        <div id="opacity-input" class="col-3"></div>
                        <script>
                            $(function() {
                                $.widget("composite_plot.opacity_input", {
                                    opacity: 0.7,

                                    _elements: {
                                        slider: null,
                                        text: null
                                    },

                                    _create: function() {
                                        let container = d3.select(this.element.context),
                                            label = container.append("label")
                                                .attr("for", "opacity-slider")
                                                .text("Opacity:"),
                                            slider = container.append("input")
                                                .attr("type", "range")
                                                .attr("id", "opacity-slider")
                                                .attr("value", this.opacity * 100)
                                                .attr("min", 0)
                                                .attr("max", 100)
                                                .on("input", function() {$("#opacity-input").opacity_input("change_opacity", parseInt(this.value) / 100)}),
                                            text = container.append("input")
                                                .attr("type", "text")
                                                .attr("id", "opacity-text")
                                                .attr("class", "slider-text")
                                                .attr("value", this.opacity)
                                                .on("change", function() {$("#opacity-input").opacity_input("change_opacity", parseFloat(this.value))});

                                        this._elements.slider = slider;
                                        this._elements.text = text
                                    },

                                    change_opacity: function(new_opacity) {
                                        this.opacity = new_opacity;
                                        this._elements.slider.node().value = new_opacity * 100;
                                        this._elements.text.node().value = new_opacity;
                                        $("#main-plot").main_plot("change_opacity", true, new_opacity)
                                    }
                                });

                                $("#opacity-input").opacity_input()
                            })
                        </script>
                        <div id="smoothing-input" class="col-3"></div>
                        <script>
                            $(function() {
                                $.widget("composite_plot.smoothing_input", {
                                    sliding_window: 7,

                                    _elements: {
                                        slider: null,
                                        text: null
                                    },

                                    _create: function() {
                                        let container = d3.select(this.element.context),
                                            label = container.append("label")
                                                .attr("for", "smoothing-slider")
                                                .text("Smoothing:"),
                                            slider = container.append("input")
                                                .attr("type", "range")
                                                .attr("id", "smoothing-slider")
                                                .attr("value", this.sliding_window)
                                                .attr("min", 1)
                                                .attr("max", 30)
                                                .on("input", function() {$("#smoothing-input").smoothing_input("change_smoothing", parseInt(this.value))}),
                                            text = container.append("input")
                                                .attr("type", "text")
                                                .attr("id", "smoothing-text")
                                                .attr("class", "slider-text")
                                                .attr("value", this.sliding_window)
                                                .on("change", function() {$("#smoothing-input").smoothing_input("change_smoothing", parseInt(this.value))});

                                        this._elements.slider = slider;
                                        this._elements.text = text
                                    },

                                    change_smoothing: function(new_window) {
                                        this.sliding_window = new_window;
                                        this._elements.slider.node().value = new_window;
                                        this._elements.text.node().value = new_window;
                                        $("#main-plot").main_plot("change_smoothing", new_window)
                                    }
                                });

                                $("#smoothing-input").smoothing_input()
                            })
                        </script>
                        <div id="shift-input" class="col-3"></div>
                        <script>
                            $(function() {
                                $.widget("composite_plot.shift_input", {
                                    bp_shift: 0,

                                    _elements: {
                                        slider: null,
                                        text: null
                                    },

                                    _create: function() {
                                        let container = d3.select(this.element.context),
                                            label = container.append("label")
                                                .attr("for", "shift-slider")
                                                .text("BP shift:"),
                                            slider = container.append("input")
                                                .attr("type", "range")
                                                .attr("id", "shift-slider")
                                                .attr("value", this.bp_shift)
                                                .attr("min", -50)
                                                .attr("max", 50)
                                                .on("input", function() {$("#shift-input").shift_input("change_shift", parseInt(this.value))})
                                            text = container.append("input")
                                                .attr("type", "text")
                                                .attr("id", "shift-text")
                                                .attr("class", "slider-text")
                                                .attr("value", this.bp_shift)
                                                .on("change", function() {$("#shift-input").shift_input("change_shift", parseInt(this.value))});

                                        this._elements.slider = slider;
                                        this._elements.text = text
                                    },

                                    change_shift: function(new_shift) {
                                        this.bp_shift = new_shift;
                                        this._elements.slider.node().value = new_shift;
                                        this._elements.text.node().value = new_shift;
                                        $("#main-plot").main_plot("change_bp_shift", new_shift)
                                    }
                                });

                                $("#shift-input").shift_input()
                            })
                        </script>
                        <div class="col-3">
                            <div class="row">
                                <div class="col-6">
                                    <label for="combined-checkbox">Combined</label>
                                    <input id="combined-checkbox" type="checkbox">
                                    <script>
                                        $(function() {
                                            $("#combined-checkbox").on("change", function() {
                                                $("#main-plot").main_plot("toggle_combined", this.checked)
                                            })
                                        })
                                    </script>
                                </div>
                                <div class="col-6">
                                    <input type="button" id="download-svg-button" value="Download as SVG">
                                    <script>
                                        $(function() {
                                            $("#download-svg-button").on("click", function() {
                                                $("#main-plot").main_plot("download_as_svg")
                                            })
                                        })
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col" style="overflow:auto; height:calc(50vh - 120px);">
                    <h4>Composite settings</h4>
                    <table id="settings-table" class="table"></table>
                    <script>
                        let parse_composite = function(text) {
                            let lines = text.split("\n"),
                                xdomain, sense, anti;
                            for (let i = 0; i < 3; i++) {
                                let line = lines[i],
                                    fields = line.split("\t");
                                if (i === 0) {
                                    xdomain = fields.slice(1).map(p => parseInt(p))
                                    if (xdomain[0] === 0) {
                                        xdomain = xdomain.map(x => x - Math.floor(xdomain.length / 2))
                                    }
                                } else if (fields[0].includes("sense")) {
                                    sense = fields.slice(1).map(o => parseFloat(o))
                                } else if (fields[0].includes("anti")) {
                                    anti = fields.slice(1).map(o => parseFloat(o))
                                }
                            };
                            return {xdomain: xdomain, sense: sense, anti: anti}
                        };

                        let sliding_window = function(xdomain, occupancy, window) {
                            let occupancy_val = occupancy.slice(0, window).reduce((a, c) => a + c, 0) / window,
                                new_xdomain = [(xdomain[0] + xdomain[window - 1]) / 2],
                                new_occupancy = [occupancy_val];
                            for (let i = 0; i < occupancy.length - window - 1; i++) {
                                new_xdomain.push((xdomain[i + 1] + xdomain[i + window]) / 2);
                                occupancy_val += (occupancy[i + window] - occupancy[i]) / window;
                                new_occupancy.push(occupancy_val);
                            };
                            return {new_xdomain: new_xdomain, new_occupancy: new_occupancy}
                        };

                        $(function() {
                            // Settings table widget
                            $.widget("composite_plot.settings_table", {
                                // Default colors
                                colors: [
                                    "#BFBFBF",
                                    "#000000",
                                    "#FF0000",
                                    "#FF9100",
                                    "#D7D700",
                                    "#07E200",
                                    "#00B0F0",
                                    "#0007FF",
                                    "#A700FF",
                                    "#FF00D0"
                                ],

                                // Counter for the number of rows added
                                rows_added: 0,

                                _elements: {
                                    table: null,
                                    rows: []
                                },

                                _create: function() {
                                    this._elements.table = d3.select(this.element.context)
                                },

                                // Add a new row to the table
                                add_row: function() {
                                    let new_row = this._elements.table.append("tr"),
                                        color = this.colors[this.rows_added % this.colors.length];
                                    $(new_row.node()).settings_row({idx: this._elements.rows.length, name: "Composite " + this.rows_added, color: color});
                                    this._elements.rows.push(new_row);

                                    // Add a new composite to the plot
                                    $("#main-plot").main_plot("add_composite", "Composite " + this.rows_added++, color)
                                },

                                // Remove a row from the table
                                remove_row: function(i) {
                                    $(this._elements.rows[i].node()).settings_row("destroy");
                                    this._elements.rows.splice(i, 1);

                                    // Update the indices of the remaining rows
                                    for (let j in this._elements.rows) {
                                        $(this._elements.rows[j].node()).settings_row("set_index", j)
                                    }
                                },

                                plot_all_composites: function(scale_axes=false) {
                                    if (scale_axes) {
                                        $("#main-plot").main_plot("scale_axes", scale_axes.xmin, scale_axes.xmax, scale_axes.ymax, this._elements.rows.reduce(function(sum, row) {
                                            let inst = $(row.node()).settings_row("instance");
                                            return sum + (inst.files_loaded && !inst.hide)
                                        }, 0) === 1, true)
                                    };

                                    for (let row of this._elements.rows) {
                                        $(row.node()).settings_row("plot_composite")
                                    }
                                },

                                insert_row: function(drag_idx, drop_idx, insert_after) {
                                    if (drag_idx !== drop_idx) {
                                        let drag_row = this._elements.rows[drag_idx],
                                            drop_row = this._elements.rows[drop_idx];
                                        if (insert_after) {
                                            $(drag_row.node()).insertAfter(drop_row.node());
                                        } else {
                                            $(drag_row.node()).insertBefore(drop_row.node());
                                        };

                                        this._elements.rows.splice(drag_idx, 1);
                                        this._elements.rows.splice(drop_idx + insert_after - (drop_idx > drag_idx), 0, drag_row);

                                        // Update the indices of the remaining rows
                                        for (let i in this._elements.rows) {
                                            $(this._elements.rows[i].node()).settings_row("set_index", i)
                                        }
                                    }
                                },

                                autoscale_axes: function() {
                                    if (!this._elements.rows.some(function(row) {let inst = $(row.node()).settings_row("instance"); return inst.files_loaded && !inst.hide})) {
                                        $("#main-plot").main_plot("scale_axes", -500, 500, 1)
                                    } else {
                                        let xmin = Infinity,
                                            xmax = -Infinity,
                                            ymax = -Infinity;
                                        this._elements.rows.forEach(function(row) {
                                            let inst = $(row.node()).settings_row("instance");
                                            if (inst.files_loaded && !inst.hide) {
                                                xmin = Math.min(xmin, inst.xmin);
                                                xmax = Math.max(xmax, inst.xmax);
                                                ymax = Math.max(ymax, Math.max(...inst.sense, ...inst.anti) * inst.scale)
                                            }
                                        });

                                        $("#main-plot").main_plot("scale_axes", xmin, xmax, ymax, true, true);
                                        this.plot_all_composites()
                                    }
                                },

                                update_ids: function(i, new_ids) {
                                    $(this._elements.rows[i].node()).settings_row("update_ids", new_ids)
                                },

                                export: function() {
                                    return this._elements.rows.map(row => $(row.node()).settings_row("export"));
                                },

                                import: function(data) {
                                    for (let i in data) {
                                        this.add_row();
                                        $(this._elements.rows[i].node()).settings_row("import", data[i])
                                    }
                                },

                                reset: function() {
                                    this.rows_added = 0;
                                    this._elements.table.selectAll("*").remove();
                                    this._elements.rows = [];
                                    this._create()
                                }
                            });

                            // Settings row widget
                            $.widget("composite_plot.settings_row", {
                                xmin: Infinity,
                                xmax: -Infinity,
                                sense: null,
                                anti: null,
                                composites: null,
                                scale: 1,
                                opacity: false,
                                smoothing: false,
                                bp_shift: false,
                                hide: false,
                                files_loaded: 0,

                                options: {
                                    idx: null,
                                    name: null,
                                    color: null
                                },

                                // Create a new row
                                _create: function() {
                                    // Add event listeners
                                    let row = d3.select(this.element.context)
                                        .classed("added-row", true)
                                        .attr("draggable", true)
                                        .on("mouseover", function(e) {$(row.node()).settings_row("highlight_row", e, "mouse-highlight")})
                                        .on("mouseleave", function(e) {$(row.node()).settings_row("unhighlight_row", e, "mouse-highlight")})
                                        .on("dragstart", function(e) {e.dataTransfer.setData("text/plain", $(row.node()).settings_row("option", "idx"))})
                                        .on("dragover", function(e) {$(row.node()).settings_row("highlight_row", e, "drag-highlight")})
                                        .on("dragleave", function(e) {$(row.node()).settings_row("unhighlight_row", e, "drag-highlight")})
                                        .on("drop", function(e) {
                                            $(row.node()).settings_row("unhighlight_row", e, "drag-highlight");
                                            $(row.node()).settings_row("direct_drop_event", e)
                                        }),

                                    // Add sliders and buttons
                                        name_col = row.append("td")
                                        .classed("name-col", true),
                                        color_col = row.append("td")
                                        .classed("color-col", true),
                                        scale_col = row.append("td")
                                        .classed("scale-col", true),
                                        opacity_col = row.append("td")
                                        .classed("opacity-col", true),
                                        smoothing_col = row.append("td")
                                        .classed("smoothing-col", true),
                                        shift_col = row.append("td")
                                        .classed("shift-col", true),
                                        hide_col = row.append("td")
                                        .classed("hide-col", true),
                                        upload_col = row.append("td")
                                        .classed("upload-col", true),
                                        id_col = row.append("td")
                                        .classed("id-col", true),
                                        reset_col = row.append("td")
                                        .classed("reset-col", true);

                                    // Add name input
                                    name_col.append("div")
                                        .attr("contenteditable", true)
                                        .text(this.options.name)
                                        .on("input", function() {$(row.node()).settings_row("change_name", this.textContent)})
                                        .on("mousedown", function() {$(row.node()).settings_row("toggle_draggable", false)})
                                        .on("mouseup", function() {$(row.node()).settings_row("toggle_draggable", true)})
                                        .on("mouseleave", function() {$(row.node()).settings_row("toggle_draggable", true)});

                                    // Add color input
                                    color_col.append("input")
                                        .attr("type", "color")
                                        .attr("value", this.options.color)
                                        .on("change", function() {$(row.node()).settings_row("change_color", this.value)});

                                    // Add scale input
                                    scale_col.append("label")
                                        .text("Scale:");
                                    scale_col.append("input")
                                        .attr("type", "text")
                                        .classed("setting-text", true)
                                        .attr("value", 1)
                                        .on("change", function() {$(row.node()).settings_row("change_scale", this.value)})
                                        .on("mousedown", function() {$(row.node()).settings_row("toggle_draggable", false)})
                                        .on("mouseup", function() {$(row.node()).settings_row("toggle_draggable", true)})
                                        .on("mouseleave", function() {$(row.node()).settings_row("toggle_draggable", true)});

                                    // Add opacity input
                                    opacity_col.append("label")
                                        .text("Opacity:");
                                    opacity_col.append("input")
                                        .attr("type", "text")
                                        .classed("setting-text", true)
                                        .on("change", function() {$(row.node()).settings_row("change_opacity", this.value)})
                                        .on("mousedown", function() {$(row.node()).settings_row("toggle_draggable", false)})
                                        .on("mouseup", function() {$(row.node()).settings_row("toggle_draggable", true)})
                                        .on("mouseleave", function() {$(row.node()).settings_row("toggle_draggable", true)});

                                    // Add smoothing input
                                    smoothing_col.append("label")
                                        .text("Smoothing:");
                                    smoothing_col.append("input")
                                        .attr("type", "text")
                                        .classed("setting-text", true)
                                        .on("change", function() {$(row.node()).settings_row("change_smoothing", this.value)})
                                        .on("mousedown", function() {$(row.node()).settings_row("toggle_draggable", false)})
                                        .on("mouseup", function() {$(row.node()).settings_row("toggle_draggable", true)})
                                        .on("mouseleave", function() {$(row.node()).settings_row("toggle_draggable", true)});

                                    // Add bp shift input
                                    shift_col.append("label")
                                        .text("BP shift:");
                                    shift_col.append("input")
                                        .attr("type", "text")
                                        .classed("setting-text", true)
                                        .on("change", function() {$(row.node()).settings_row("change_bp_shift", this.value)})
                                        .on("mousedown", function() {$(row.node()).settings_row("toggle_draggable", false)})
                                        .on("mouseup", function() {$(row.node()).settings_row("toggle_draggable", true)})
                                        .on("mouseleave", function() {$(row.node()).settings_row("toggle_draggable", true)});

                                    // Add hide icon
                                    let eye_open_icon = hide_col.append("div")
                                        .attr("title", "Hide")
                                        .append("svg")
                                            .classed("hide-icon", true)
                                            .classed("eye-open", true)
                                            .attr("baseProfile", "full")
                                            .attr("viewBox", "-100 -100 200 200")
                                            .attr("version", "1.1")
                                            .attr("xmlns", "http://www.w3.org/2000/svg")
                                            .on("click", function() {$(row.node()).settings_row("toggle_hide", true)})
                                            .append("g");
                                    eye_open_icon.append("path")
                                        .attr("d", "M-100 0C-50 60 50 60 100 0C50 -60 -50 -60 -100 0")
                                        .attr("fill", "none")
                                        .attr("stroke", "black")
                                        .attr("stroke-width", 3);
                                    eye_open_icon.append("circle")
                                        .attr("cx", 0)
                                        .attr("cy", 0)
                                        .attr("r", 30)
                                        .attr("fill", "black")
                                        .attr("stroke", "none");
                                    let eye_closed_icon = hide_col.append("div")
                                        .attr("title", "Show")
                                        .append("svg")
                                            .classed("hide-icon", true)
                                            .classed("eye-closed", true)
                                            .attr("title", "Show")
                                            .attr("baseProfile", "full")
                                            .attr("viewBox", "-100 -100 200 200")
                                            .attr("version", "1.1")
                                            .attr("xmlns", "http://www.w3.org/2000/svg")
                                            .style("display", "none")
                                            .on("click", function() {$(row.node()).settings_row("toggle_hide", false)})
                                            .append("g");
                                    eye_closed_icon.append("path")
                                        .attr("d", "M-100 0C-50 60 50 60 100 0M-66.77 27.7L-74.21 40.78M-24.62 42.82L-27.26 57.58M24.62 42.82L27.26 57.58M66.77 27.7L74.21 40.78")
                                        .attr("fill", "none")
                                        .attr("stroke", "black")
                                        .attr("stroke-width", 3);

                                    // Add file upload button
                                    let file_input = upload_col.append("input")
                                        .attr("type", "file")
                                        .property("multiple", true)
                                        .style("display", "none")
                                        .on("change", function(ev) {$(row.node()).settings_row("load_files", ev.target.files)});
                                    upload_col.append("button")
                                        .attr("title", "Upload file(s)")
                                        .style("width", "35px")
                                        .style("height", "30px")
                                        .style("position", "relative")
                                        .on("click", function() {$(file_input.node()).click()})
                                        .append("svg")
                                            .classed("upload-icon", true)
                                            .attr("baseProfile", "full")
                                            .attr("viewBox", "0 0 24 24")
                                            .attr("version", "1.1")
                                            .attr("xmlns", "http://www.w3.org/2000/svg")
                                            .style("position", "absolute")
                                            .style("top", "5px")
                                            .style("left", "6px")
                                            .append("g")
                                                .append("path")
                                                    .attr("d", "M9 10L12 7L15 10M12 7V21M20 7V4a1 1 0 0 0 -1 -1H5A1 1 0 0 0 4 4V7")
                                                    .attr("stroke", "#000000")
                                                    .attr("stroke-width", 2)
                                                    .attr("stroke-linejoin", "round")
                                                    .attr("fill", "none");
                                    upload_col.append("label")
                                        .style("padding-left", "10px")
                                        .text("No files loaded");

                                    // Show IDs
                                    id_col.append("div")
                                        .style("display", "inline-block")
                                        .style("vertical-align", "top")
                                        .text("IDs:");
                                    id_col.append("div")
                                        .style("display", "inline-block")
                                        .style("vertical-align", "top")
                                        .style("padding-left", "5px")
                                        .classed("id-list", true);

                                    // Add reset button
                                    reset_col.append("input")
                                        .attr("type", "button")
                                        .attr("value", "Reset")
                                        .on("click", function() {$(row.node()).settings_row("reset")})
                                },

                                // Remove the row
                                _destroy: function() {
                                    d3.select(this.element.context).remove()
                                },

                                // Set the row index
                                set_index: function(i) {
                                    this.options.idx = i
                                },

                                // Highlight the row
                                highlight_row: function(ev, hl_class) {
                                    ev.preventDefault();
                                    d3.select(this.element.context).classed(hl_class, true);
                                    $("#metadata-table").metadata_table("highlight_row", this.options.idx)
                                },

                                // Unhighlight the row
                                unhighlight_row: function(ev, hl_class) {
                                    ev.preventDefault();
                                    d3.select(this.element.context).classed(hl_class, false);
                                    $("#metadata-table").metadata_table("unhighlight_row", this.options.idx)
                                },

                                // Handle drop event
                                direct_drop_event: function(ev) {
                                    ev.preventDefault();
                                    if (ev.dataTransfer.items[0].kind === "file") {
                                        let file_list = [];
                                        for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                                            file_list.push(ev.dataTransfer.items[i].getAsFile())
                                        };
                                        this.load_files(file_list)
                                    } else {
                                        this.insert_row(parseInt(ev.dataTransfer.getData("text/plain")), event.clientY)
                                    }
                                },

                                // Load composite files
                                load_files: async function(file_list) {
                                    let widg = this,
                                        n = file_list.length,
                                        xmin_curr = this.xmin,
                                        xmax_curr = this.xmax,
                                        promise_arr = Array(n),
                                        composite_arr = Array(n);

                                    // Read files
                                    for (let i = 0; i < n; i++) {
                                        await new Promise(function(resolve) {
                                            let file = file_list[i],
                                                reader = new FileReader(),
                                                id = file.name.split(/[_.]/)[0];

                                            $("#metadata-table").metadata_table("add_id", widg.options.idx, id);
                                            widg.add_id(id);

                                            reader.onload = function() {
                                                let {xdomain, sense, anti} = parse_composite(reader.result),
                                                    promise = () => new Promise(function(resolve_) {

                                                    // Update xdomain
                                                    let xmin = Math.min(widg.xmin, xdomain[0]),
                                                        xmax = Math.max(widg.xmax, xdomain[xdomain.length - 1]);
                                                    widg.xmin = xmin;
                                                    widg.xmax = xmax;

                                                    resolve_()
                                                });
                                                promise_arr[i] = i === 0 ? promise() : promise_arr[i - 1].then(promise);

                                                // Update composite array
                                                composite_arr[i] = {xdomain: xdomain, sense: sense, anti: anti};

                                                resolve()
                                            };

                                            reader.onerror = function() {
                                                alert("Error loading file!!");
                                                throw "Error loading file"
                                            };

                                            reader.readAsText(file)
                                        })
                                    };

                                    // Wait for xdomain and composite arrays to be updated
                                    await promise_arr[n - 1];

                                    // If no files, initialize sense and anti arrays; otherwise, pad sense and anti arrays to new xdomain
                                    if (this.files_loaded === 0) {
                                        this.sense = Array(this.xmax - this.xmin + 1).fill(0);
                                        this.anti = Array(this.xmax - this.xmin + 1).fill(0);
                                    } else {
                                        let prefix = Array(xmin_curr - this.xmin).fill(0),
                                            suffix = Array(this.xmax - xmax_curr).fill(0);
                                        this.sense.unshift(...prefix);
                                        this.sense.push(...suffix);
                                        this.anti.unshift(...prefix);
                                        this.anti.push(...suffix)
                                    };

                                    // Update sense and anti arrays
                                    for (let i = 0; i < n; i++) {
                                        let {xdomain, sense, anti} = composite_arr[i];
                                        for (let j = xdomain[0] - this.xmin; j <= xdomain[xdomain.length - 1] - xdomain[0]; j++) {
                                            let idx = xdomain[0] - this.xmin + j;
                                            this.sense[idx] += sense[j];
                                            this.anti[idx] += anti[j]
                                        }
                                    };

                                    // Update files loaded
                                    this.files_loaded += file_list.length;
                                    d3.select(this.element.context).select("td.upload-col").select("label")
                                        .text(this.files_loaded === 1 ? this.files_loaded + " file loaded" : this.files_loaded + " files loaded");

                                    // Update composite plot
                                    $("#settings-table").settings_table("plot_all_composites", {xmin: this.xmin, xmax: this.xmax, ymax: Math.max(...this.sense, ...this.anti)});
                                    $("#main-plot").main_plot("update_legend")
                                },

                                // Plot composite data
                                plot_composite: function() {
                                    if (this.files_loaded) {
                                        $("#main-plot").main_plot("plot_composite", this.xmin, this.xmax, this.sense, this.anti, this.scale, this.options.color, this.options.idx, this.opacity, this.smoothing, this.bp_shift, this.hide)
                                    }
                                },

                                insert_row: function(idx, drop_y) {
                                    let {y, height} = this.element.context.getBoundingClientRect(),
                                        this_idx = parseInt(this.options.idx),
                                        insert_after = drop_y > y + (height / 2);
                                    $("#metadata-table").metadata_table("insert_row", idx, this_idx, insert_after);
                                    $("#main-plot").main_plot("change_order", idx, this_idx, insert_after);
                                    $("#settings-table").settings_table("insert_row", idx, this_idx, insert_after)
                                },

                                toggle_draggable: function(val) {
                                    d3.select(this.element.context).attr("draggable", val)
                                },

                                change_name: function(new_name, change_text=false) {
                                    this.options.name = new_name;
                                    $("#main-plot").main_plot("change_name", this.options.idx, new_name);

                                    if (change_text) {
                                        d3.select(this.element.context).select("td.name-col").select("div").text(new_name)
                                    }
                                },

                                change_color: function(new_color, plot=true) {
                                    this.options.color = new_color;
                                    d3.select(this.element.context).select("td.color-col").select("input").attr("value", new_color);

                                    if (plot) {
                                        $("#main-plot").main_plot("change_color", this.options.idx, new_color)
                                    }
                                },

                                change_scale: function(new_scale, plot=true) {
                                    if (new_scale === "" || isNaN(new_scale)) {
                                        d3.select(this.element.context).select("td.scale-col").select("input").node().value = this.scale;
                                    } else {
                                        this.scale = new_scale;
                                        d3.select(this.element.context).select("td.scale-col").select("input").node().value = new_scale;
                                        if (plot) {
                                            this.plot_composite()
                                        }
                                    }
                                },

                                change_opacity: function(new_opacity, plot=true) {
                                    if (new_opacity === "" || isNaN(new_opacity) || new_opacity === false) {
                                        d3.select(this.element.context).select("td.opacity-col").select("input").node().value = this.opacity === false ? "" : this.opacity
                                    } else {
                                        new_opacity = Math.min(Math.max(parseFloat(new_opacity), 0), 1);
                                        this.opacity = new_opacity;
                                        d3.select(this.element.context).select("td.opacity-col").select("input").node().value = new_opacity;
                                        if (plot) {
                                            $("#main-plot").main_plot("change_opacity", this.options.idx, new_opacity)
                                        }
                                    }
                                },

                                change_smoothing: function(new_smoothing, plot=true) {
                                    if (new_smoothing === "" || isNaN(new_smoothing) || new_smoothing === false) {
                                        d3.select(this.element.context).select("td.smoothing-col").select("input").node().value = this.smoothing === false ? "" : this.smoothing;
                                    } else {
                                        new_smoothing = Math.max(parseInt(new_smoothing), 1);
                                        this.smoothing = new_smoothing;
                                        d3.select(this.element.context).select("td.smoothing-col").select("input").node().value = new_smoothing;
                                        if (plot) {
                                            this.plot_composite()
                                        }
                                    }
                                },

                                change_bp_shift: function(new_bp_shift, plot=true) {
                                    if (new_bp_shift === "" || isNaN(new_bp_shift) || new_bp_shift === false) {
                                        d3.select(this.element.context).select("td.shift-col").select("input").node().value = this.bp_shift === false ? "" : this.bp_shift;
                                    } else {
                                        new_bp_shift = parseInt(new_bp_shift);
                                        this.bp_shift = new_bp_shift;
                                        d3.select(this.element.context).select("td.shift-col").select("input").node().value = new_bp_shift;
                                        if (plot) {
                                            this.plot_composite()
                                        }
                                    }
                                },

                                toggle_hide: function(hide, plot=true) {
                                    this.hide = hide;
                                    let hide_col = d3.select(this.element.context).select("td.hide-col");
                                    hide_col.select(".eye-open")
                                        .style("display", hide ? "none" : null);
                                    hide_col.select(".eye-closed")
                                        .style("display", hide ? null : "none");

                                    if (plot && this.files_loaded) {
                                        $("#main-plot").main_plot("toggle_hide", this.options.idx, hide)
                                    }
                                },

                                add_id: function(id) {
                                    let id_list = d3.select(this.element.context).select(".id-col").select(".id-list"),
                                        id_list_text = id_list.text();
                                    id_list.text(id_list_text ? (id_list_text + ", " + id) : id)
                                },

                                update_ids: function(new_ids) {
                                    d3.select(this.element.context).select(".id-col").select(".id-list").text(new_ids)
                                },

                                reset: function() {
                                    this.files_loaded = 0;
                                    this.xmin = Infinity;
                                    this.xmax = -Infinity;
                                    this.sense = null;
                                    this.anti = null;
                                    this.options.name = "Composite " + this.options.idx;
                                    this.scale = 1;
                                    this.opacity = false;
                                    this.smoothing = false;
                                    this.bp_shift = false;
                                    this.hide = false;
                                    d3.select(this.element.context).select("td.name-col").select("div").text(this.options.name);
                                    d3.select(this.element.context).select("td.scale-col").select("input").node().value = "";
                                    d3.select(this.element.context).select("td.opacity-col").select("input").node().value = "";
                                    d3.select(this.element.context).select("td.smoothing-col").select("input").node().value = "";
                                    d3.select(this.element.context).select("td.shift-col").select("input").node().value = "";
                                    d3.select(this.element.context).select("td.upload-col").select("label").text("No files loaded");
                                    this.update_ids("");
                                    $("#metadata-table").metadata_table("reset_row", this.options.idx);
                                    $("#main-plot").main_plot("reset_composite", this.options.idx)
                                },

                                export: function() {
                                    return {
                                        name: this.options.name,
                                        xmin: this.xmin,
                                        xmax: this.xmax,
                                        sense: this.sense,
                                        anti: this.anti,
                                        color: this.options.color,
                                        scale: this.scale,
                                        opacity: this.opacity,
                                        smoothing: this.smoothing,
                                        bp_shift: this.bp_shift,
                                        hide: this.hide,
                                        files_loaded: this.files_loaded
                                    }
                                },

                                import: function(data) {
                                    this.change_name(data.name, true);
                                    this.change_color(data.color);
                                    this.change_scale(data.scale, false);
                                    this.change_opacity(data.opacity, false);
                                    this.change_smoothing(data.smoothing, false);
                                    this.change_bp_shift(data.bp_shift, false);
                                    this.toggle_hide(data.hide, false);
                                    this.files_loaded = data.files_loaded;
                                    this.xmin = data.xmin === null ? Infinity : data.xmin
                                    this.xmax = data.xmax === null ? -Infinity : data.xmax;
                                    this.sense = data.sense;
                                    this.anti = data.anti;
                                    d3.select(this.element.context).select("td.upload-col").select("label")
                                        .text(this.files_loaded === 1 ? this.files_loaded + " file loaded" : this.files_loaded + " files loaded");
                                    this.plot_composite()
                                }
                            });

                            $("#settings-table").settings_table()
                        })
                    </script>
                </div>
            </div>
        </div>
    </main>
</body>